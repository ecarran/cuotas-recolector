name: Backup cuotas.csv desde memoria

on:
  schedule:
    - cron: '0 6,18 * * *'  # Dos veces al día: 06:00 y 18:00 UTC
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Set up job
        run: echo "Iniciando backup Cuotas"

      - name: Llamar a /recolectar para asegurar que hay datos
        run: |
          curl -s https://cuotas-recolector.onrender.com/recolectar
          echo "Esperando 10s para que Render procese..."
          sleep 10

      - name: Descargar CSV
        run: |
          curl -o cuotas.csv https://cuotas-recolector.onrender.com/descargar-csv
          if [ ! -s cuotas.csv ]; then
            echo "❌ Error: el archivo CSV está vacío"
            cat cuotas.csv
            exit 1
          fi

      - name: Crear carpeta y mover archivo
        run: |
          mkdir -p backups
          TS=$(date +'%Y-%m-%d_%H-%M')
          mv cuotas.csv "backups/cuotas_$TS.csv"

      - name: Configurar Git
        run: |
          git config --global user.email "bot@example.com"
          git config --global user.name "GitHub Actions Bot"

      - name: Inicializar y subir archivo al repositorio
        run: |
          git init
          git remote add origin https://github.com/${{ github.repository }}
          git checkout main || git checkout -b main
          git pull origin main
          git add backups/
          if git diff --cached --quiet; then
            echo "✅ Sin cambios, no se hace commit"
          else
            git commit -m "Backup automático del $(date +'%Y-%m-%d %H:%M')"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git main
          fi
